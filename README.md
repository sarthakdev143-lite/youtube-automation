# Media Factory

Spring Boot app that:
- accepts an image + audio upload
- generates an MP4 with FFmpeg
- uploads the result to YouTube
- returns an async `jobId` and exposes job status polling

## Prerequisites

- Java 17
- FFmpeg installed
- Google Cloud OAuth client credentials for YouTube Data API v3

## Configuration

The app supports these environment variables:

- `FFMPEG_PATH` (optional): absolute path to ffmpeg executable. If unset, app uses `ffmpeg` from `PATH`.
- `YOUTUBE_CREDENTIALS_PATH` (optional): path to OAuth client credentials JSON. If unset, app expects `secrets/credentials.json`.

Important server setting:
- `server.tomcat.max-part-count=100` is configured in `application.properties` to allow multipart requests with publishing fields (including tags and thumbnail).

Startup preflight checks verify FFmpeg and credentials path. If either is invalid, startup fails fast with a clear error.

## OAuth Setup

1. In Google Cloud Console, enable **YouTube Data API v3**.
2. Create OAuth client credentials (Desktop App or Web App).
3. Download the JSON and either:
   - save as `secrets/credentials.json`, or
   - set `YOUTUBE_CREDENTIALS_PATH` to its location.
4. If using a Web App OAuth client, include redirect URI:
   - `http://localhost:8888/oauth2callback`

## Run

```powershell
.\mvnw.cmd spring-boot:run
```

On first upload, a browser consent flow is triggered. Tokens are stored under `.youtube-tokens/`.

## API

### Submit Job

`POST /api/video/generate`  
Content-Type: `multipart/form-data`

Required fields:
- `image` (file, `image/*`)
- `audio` (file, `audio/*`)
- `duration` (integer seconds, `1` to `36000`)
- `title` (max `100` chars)
- `description` (max `5000` chars)

Optional publishing fields:
- `privacyStatus`: `PRIVATE | UNLISTED | PUBLIC` (case-insensitive, default `PRIVATE`)
- `tags`: repeated field (`-F "tags=tag1" -F "tags=tag2"`), max 20 unique tags, each max 50 chars
- `categoryId`: numeric string matching `^\d{1,3}$`
- `publishAt`: ISO-8601 UTC instant ending with `Z` (example `2026-02-20T18:30:00Z`), must be at least 5 minutes in future
- `thumbnail`: optional image file (`image/jpeg` or `image/png`)

Validation rules:
- `publishAt` requires `privacyStatus=PRIVATE`
- invalid optional field values return `400 Bad Request`

Successful response: `202 Accepted`

```json
{
  "jobId": "2f8360f0-7bfd-40f3-9a3a-ce1e5f0f3a21",
  "state": "QUEUED",
  "message": "Video job accepted. Poll /api/video/status/{jobId} for progress."
}
```

### Check Job Status

`GET /api/video/status/{jobId}`

Successful response: `200 OK`

```json
{
  "jobId": "2f8360f0-7bfd-40f3-9a3a-ce1e5f0f3a21",
  "state": "COMPLETED",
  "message": "Video generated and uploaded successfully.",
  "createdAt": "2026-02-12T18:25:43.129Z",
  "updatedAt": "2026-02-12T18:26:07.984Z",
  "privacyStatus": "PRIVATE",
  "tags": ["music", "ambient"],
  "categoryId": "10",
  "publishAt": "2026-02-20T18:30:00Z",
  "youtubeVideoId": "abc123xyz",
  "youtubeVideoUrl": "https://www.youtube.com/watch?v=abc123xyz",
  "warningMessage": null
}
```

States: `QUEUED`, `PROCESSING`, `COMPLETED`, `FAILED`

## cURL Examples

Immediate upload with metadata:

```bash
curl -X POST "http://localhost:8080/api/video/generate" \
  -F "image=@/path/to/image.jpg" \
  -F "audio=@/path/to/audio.mp3" \
  -F "duration=60" \
  -F "title=My Test Video" \
  -F "description=Generated by Media Factory" \
  -F "privacyStatus=UNLISTED" \
  -F "tags=music" \
  -F "tags=chill" \
  -F "categoryId=10" \
  -F "thumbnail=@/path/to/thumb.jpg"
```

Scheduled private upload:

```bash
curl -X POST "http://localhost:8080/api/video/generate" \
  -F "image=@/path/to/image.jpg" \
  -F "audio=@/path/to/audio.mp3" \
  -F "duration=60" \
  -F "title=Scheduled Video" \
  -F "description=Publish later" \
  -F "privacyStatus=PRIVATE" \
  -F "publishAt=2026-02-20T18:30:00Z"
```

Then poll:

```bash
curl "http://localhost:8080/api/video/status/<jobId>"
```

## Tests

```powershell
.\mvnw.cmd test
```

`src/test/resources/application.properties` disables startup preflight checks to keep tests isolated from local FFmpeg/credential setup.
