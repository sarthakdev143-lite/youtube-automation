<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Media Factory</title>
    <style>
        :root {
            --bg: #0f1218;
            --panel: #181d27;
            --panel-soft: #111621;
            --text: #f5f8ff;
            --muted: #a8b3c8;
            --accent: #2a9d8f;
            --accent-hover: #228679;
            --danger: #d45151;
            --border: #2a3344;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            padding: 30px 14px;
            color: var(--text);
            background: radial-gradient(circle at top, #1b2331 0%, #0f1218 52%, #090c11 100%);
            font-family: "Segoe UI", sans-serif;
            display: flex;
            justify-content: center;
        }

        .card {
            width: min(980px, 100%);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0));
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 22px;
        }

        h2 {
            margin: 0 0 14px;
        }

        p.subtitle {
            margin: 0 0 18px;
            color: var(--muted);
            font-size: 13px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        @media (min-width: 860px) {
            .grid {
                grid-template-columns: 1fr 1fr;
            }

            .full {
                grid-column: 1 / -1;
            }
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            color: var(--muted);
        }

        input,
        select,
        button,
        textarea {
            width: 100%;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--panel-soft);
            color: var(--text);
            padding: 10px;
            font-size: 14px;
        }

        textarea {
            resize: vertical;
            min-height: 92px;
        }

        button {
            border: 0;
            background: var(--accent);
            font-weight: 600;
            cursor: pointer;
        }

        button:hover {
            background: var(--accent-hover);
        }

        .section {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.02);
        }

        .section h3 {
            margin: 0 0 10px;
            font-size: 14px;
            color: #d8e2f2;
        }

        .hint {
            margin-top: 6px;
            font-size: 12px;
            color: var(--muted);
        }

        .scene-list {
            display: grid;
            gap: 10px;
        }

        .scene {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.18);
        }

        .scene-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 13px;
        }

        .scene-grid {
            display: grid;
            gap: 8px;
            grid-template-columns: 1fr;
        }

        @media (min-width: 760px) {
            .scene-grid {
                grid-template-columns: 1fr 1fr;
            }

            .scene-full {
                grid-column: 1 / -1;
            }
        }

        .btn-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            background: #31537d;
        }

        .btn-secondary:hover {
            background: #29486f;
        }

        .btn-danger {
            background: var(--danger);
            width: auto;
            padding: 6px 10px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #bf4242;
        }

        .hidden {
            display: none;
        }

        #status {
            margin-top: 16px;
            line-height: 1.45;
            white-space: pre-wrap;
            word-break: break-word;
            font-weight: 600;
        }
    </style>
</head>

<body>
<div class="card">
    <h2>Media Factory</h2>
    <p class="subtitle">Create a simple video from one image or build a multi-scene composition with mixed assets, filters, overlays, and color grading.</p>

    <form id="videoForm">
        <div class="grid">
            <div>
                <label for="mode">Mode</label>
                <select id="mode">
                    <option value="basic" selected>Basic</option>
                    <option value="composition">Composition</option>
                </select>
            </div>

            <div>
                <label for="audio">Audio (master track)</label>
                <input type="file" id="audio" accept="audio/*" required>
            </div>

            <div class="full section" id="basicSection">
                <h3>Basic Inputs</h3>
                <div class="grid">
                    <div>
                        <label for="image">Image</label>
                        <input type="file" id="image" accept="image/*">
                    </div>
                    <div>
                        <label for="duration">Duration (seconds)</label>
                        <input type="number" id="duration" min="1" max="36000">
                    </div>
                </div>
            </div>

            <div class="full section hidden" id="compositionSection">
                <h3>Composition Inputs</h3>
                <div class="grid">
                    <div>
                        <label for="outputPreset">Output Preset</label>
                        <select id="outputPreset">
                            <option value="LANDSCAPE_16_9">16:9 Landscape (1920x1080)</option>
                            <option value="PORTRAIT_9_16" selected>9:16 Portrait (1080x1920)</option>
                            <option value="SQUARE_1_1">1:1 Square (1080x1080)</option>
                        </select>
                    </div>
                </div>

                <div class="scene-list" id="sceneList"></div>
                <div class="btn-row" style="margin-top: 10px;">
                    <button type="button" id="addScene" class="btn-secondary">Add Scene</button>
                </div>
            </div>

            <div class="full">
                <label for="title">Title</label>
                <input type="text" id="title" maxlength="100" required>
            </div>

            <div class="full">
                <label for="description">Description</label>
                <textarea id="description" maxlength="5000" required></textarea>
            </div>

            <div>
                <label for="privacyStatus">Privacy</label>
                <select id="privacyStatus">
                    <option value="PRIVATE" selected>PRIVATE</option>
                    <option value="UNLISTED">UNLISTED</option>
                    <option value="PUBLIC">PUBLIC</option>
                </select>
            </div>

            <div>
                <label for="tags">Tags (comma-separated)</label>
                <input type="text" id="tags" placeholder="music, chill, morning">
            </div>

            <div>
                <label for="categoryId">Category ID (optional)</label>
                <input type="text" id="categoryId" placeholder="22">
            </div>

            <div>
                <label for="publishAt">Schedule Publish (UTC instant)</label>
                <input type="datetime-local" id="publishAt">
                <div class="hint">Converted to UTC ISO-8601 with trailing Z.</div>
            </div>

            <div>
                <label for="thumbnail">Custom Thumbnail (JPEG/PNG)</label>
                <input type="file" id="thumbnail" accept="image/jpeg,image/png">
            </div>

            <div class="full">
                <button type="submit">Generate & Upload</button>
            </div>
        </div>
    </form>

    <div id="status"></div>
</div>

<script>
    const form = document.getElementById("videoForm");
    const status = document.getElementById("status");
    const modeSelect = document.getElementById("mode");
    const basicSection = document.getElementById("basicSection");
    const compositionSection = document.getElementById("compositionSection");
    const sceneList = document.getElementById("sceneList");
    const addSceneButton = document.getElementById("addScene");
    let activePoll = null;

    modeSelect.addEventListener("change", syncModeView);
    addSceneButton.addEventListener("click", () => addSceneRow());

    syncModeView();
    addSceneRow();

    form.addEventListener("submit", async (event) => {
        event.preventDefault();

        const mode = modeSelect.value;
        const audioFile = document.getElementById("audio").files[0];
        const thumbnailFile = document.getElementById("thumbnail").files[0];
        const title = document.getElementById("title").value.trim();
        const description = document.getElementById("description").value.trim();
        const privacyStatus = document.getElementById("privacyStatus").value;
        const tagsText = document.getElementById("tags").value;
        const categoryId = document.getElementById("categoryId").value.trim();
        const publishAtLocal = document.getElementById("publishAt").value;

        if (!audioFile || !title || !description) {
            status.innerText = "Please provide audio, title, and description.";
            return;
        }

        const formData = new FormData();
        formData.append("audio", audioFile);
        formData.append("title", title);
        formData.append("description", description);
        formData.append("privacyStatus", privacyStatus);

        const tags = tagsText
            .split(",")
            .map((item) => item.trim())
            .filter(Boolean);
        if (tags.length > 0) {
            formData.append("tags", tags.join(","));
        }

        if (categoryId) {
            formData.append("categoryId", categoryId);
        }

        if (publishAtLocal) {
            formData.append("publishAt", new Date(publishAtLocal).toISOString());
        }

        if (thumbnailFile) {
            formData.append("thumbnail", thumbnailFile);
        }

        let endpoint = "/api/video/generate";

        if (mode === "basic") {
            const imageFile = document.getElementById("image").files[0];
            const duration = document.getElementById("duration").value;
            if (!imageFile || !duration) {
                status.innerText = "Basic mode requires image and duration.";
                return;
            }

            formData.append("image", imageFile);
            formData.append("duration", duration);
        } else {
            endpoint = "/api/video/compositions";
            const buildResult = buildCompositionManifest();
            if (buildResult.error) {
                status.innerText = buildResult.error;
                return;
            }

            for (const assetEntry of buildResult.assets) {
                formData.append(`asset.${assetEntry.assetId}`, assetEntry.file);
            }
            formData.append("manifest", JSON.stringify(buildResult.manifest));
        }

        status.innerText = "Uploading... Please wait.";

        try {
            const response = await fetch(endpoint, {
                method: "POST",
                body: formData,
            });

            if (!response.ok) {
                status.innerText = await response.text();
                return;
            }

            const contentType = response.headers.get("content-type") || "";
            if (!contentType.includes("application/json")) {
                status.innerText = await response.text();
                return;
            }

            const submission = await response.json();
            status.innerText = `Job ${submission.jobId}: ${submission.state}. ${submission.message}`;
            pollJobStatus(submission.jobId);
        } catch (error) {
            console.error(error);
            status.innerText = "Error: " + error.message;
        }
    });

    function syncModeView() {
        const compositionMode = modeSelect.value === "composition";
        basicSection.classList.toggle("hidden", compositionMode);
        compositionSection.classList.toggle("hidden", !compositionMode);
    }

    function addSceneRow() {
        const sceneIndex = sceneList.children.length;
        const row = document.createElement("div");
        row.className = "scene";
        row.dataset.sceneIndex = String(sceneIndex);

        row.innerHTML = `
            <div class="scene-title">
                <span>Scene ${sceneIndex + 1}</span>
                <button type="button" class="btn-danger remove-scene">Remove</button>
            </div>
            <div class="scene-grid">
                <div>
                    <label>Type</label>
                    <select class="scene-type">
                        <option value="IMAGE">IMAGE</option>
                        <option value="VIDEO">VIDEO</option>
                    </select>
                </div>
                <div>
                    <label>Asset File</label>
                    <input type="file" class="scene-asset" required>
                </div>
                <div class="scene-image-only">
                    <label>Image Duration (sec)</label>
                    <input type="number" min="0.5" max="600" step="0.1" class="scene-duration" value="3">
                </div>
                <div class="scene-video-only hidden">
                    <label>Video Clip Start (sec)</label>
                    <input type="number" min="0" step="0.1" class="scene-clip-start" value="0">
                </div>
                <div class="scene-video-only hidden">
                    <label>Video Clip Duration (sec, optional)</label>
                    <input type="number" min="0.1" step="0.1" class="scene-clip-duration" placeholder="auto if blank">
                </div>
                <div>
                    <label>Motion</label>
                    <select class="scene-motion">
                        <option value="NONE" selected>NONE</option>
                        <option value="ZOOM_IN">ZOOM_IN</option>
                        <option value="ZOOM_OUT">ZOOM_OUT</option>
                        <option value="PAN_LEFT">PAN_LEFT</option>
                        <option value="PAN_RIGHT">PAN_RIGHT</option>
                    </select>
                </div>
                <div>
                    <label>Filter</label>
                    <select class="scene-filter">
                        <option value="NONE" selected>NONE</option>
                        <option value="GRAYSCALE">GRAYSCALE</option>
                        <option value="SEPIA">SEPIA</option>
                        <option value="COOL">COOL</option>
                        <option value="WARM">WARM</option>
                    </select>
                </div>
                <div>
                    <label>Brightness (-1 to 1)</label>
                    <input type="number" min="-1" max="1" step="0.05" class="scene-brightness" value="0">
                </div>
                <div>
                    <label>Contrast (0.2 to 3)</label>
                    <input type="number" min="0.2" max="3" step="0.05" class="scene-contrast" value="1">
                </div>
                <div>
                    <label>Saturation (0 to 3)</label>
                    <input type="number" min="0" max="3" step="0.05" class="scene-saturation" value="1">
                </div>
                <div>
                    <label>Overlay Tint Color</label>
                    <input type="color" class="scene-overlay-color" value="#000000">
                </div>
                <div>
                    <label>Overlay Opacity (0 to 1)</label>
                    <input type="number" min="0" max="1" step="0.05" class="scene-overlay-opacity" value="0">
                </div>
                <div>
                    <label>Transition</label>
                    <select class="scene-transition-type">
                        <option value="CUT" selected>CUT</option>
                        <option value="CROSSFADE">CROSSFADE</option>
                    </select>
                </div>
                <div class="scene-transition-duration hidden">
                    <label>Transition Duration (sec)</label>
                    <input type="number" min="0.2" max="2" step="0.1" class="scene-transition-seconds" value="0.5">
                </div>
                <div class="scene-full">
                    <label>Caption (optional)</label>
                    <input type="text" class="scene-caption-text" maxlength="200" placeholder="Text overlay for this scene">
                </div>
                <div>
                    <label>Caption Start (sec)</label>
                    <input type="number" min="0" step="0.1" class="scene-caption-start" value="0">
                </div>
                <div>
                    <label>Caption End (sec, optional)</label>
                    <input type="number" min="0.1" step="0.1" class="scene-caption-end" placeholder="scene end if blank">
                </div>
                <div>
                    <label>Caption Position</label>
                    <select class="scene-caption-position">
                        <option value="BOTTOM" selected>BOTTOM</option>
                        <option value="CENTER">CENTER</option>
                        <option value="TOP">TOP</option>
                    </select>
                </div>
            </div>
        `;

        sceneList.appendChild(row);
        wireSceneRow(row);
        renumberScenes();
    }

    function wireSceneRow(row) {
        const typeSelect = row.querySelector(".scene-type");
        const transitionTypeSelect = row.querySelector(".scene-transition-type");
        const removeButton = row.querySelector(".remove-scene");

        typeSelect.addEventListener("change", () => syncSceneFields(row));
        transitionTypeSelect.addEventListener("change", () => syncSceneFields(row));

        removeButton.addEventListener("click", () => {
            row.remove();
            if (sceneList.children.length === 0) {
                addSceneRow();
            }
            renumberScenes();
        });

        syncSceneFields(row);
    }

    function renumberScenes() {
        Array.from(sceneList.children).forEach((sceneRow, index) => {
            sceneRow.dataset.sceneIndex = String(index);
            sceneRow.querySelector(".scene-title span").innerText = `Scene ${index + 1}`;

            const transitionType = sceneRow.querySelector(".scene-transition-type");
            const transitionDurationBlock = sceneRow.querySelector(".scene-transition-duration");
            if (index === 0) {
                transitionType.value = "CUT";
                transitionType.disabled = true;
                transitionDurationBlock.classList.add("hidden");
            } else {
                transitionType.disabled = false;
            }
        });
    }

    function syncSceneFields(row) {
        const type = row.querySelector(".scene-type").value;
        const transitionType = row.querySelector(".scene-transition-type").value;

        row.querySelectorAll(".scene-image-only").forEach((el) => {
            el.classList.toggle("hidden", type !== "IMAGE");
        });
        row.querySelectorAll(".scene-video-only").forEach((el) => {
            el.classList.toggle("hidden", type !== "VIDEO");
        });

        const transitionDurationBlock = row.querySelector(".scene-transition-duration");
        transitionDurationBlock.classList.toggle("hidden", transitionType !== "CROSSFADE");
    }

    function buildCompositionManifest() {
        const sceneRows = Array.from(sceneList.children);
        if (sceneRows.length === 0) {
            return { error: "At least one composition scene is required." };
        }

        const assets = [];
        const scenes = [];

        for (let index = 0; index < sceneRows.length; index++) {
            const row = sceneRows[index];
            const sceneType = row.querySelector(".scene-type").value;
            const assetFile = row.querySelector(".scene-asset").files[0];
            const motion = row.querySelector(".scene-motion").value;
            const transitionType = index === 0 ? "CUT" : row.querySelector(".scene-transition-type").value;
            const transitionDuration = row.querySelector(".scene-transition-seconds").value;

            if (!assetFile) {
                return { error: `Scene ${index + 1} requires an asset file.` };
            }

            const assetId = `scene-${index + 1}`;
            assets.push({ assetId, file: assetFile });

            const scene = {
                assetId,
                type: sceneType,
                motion,
                transition: {
                    type: transitionType,
                },
            };

            if (sceneType === "IMAGE") {
                const duration = row.querySelector(".scene-duration").value;
                if (!duration) {
                    return { error: `Scene ${index + 1} image duration is required.` };
                }
                scene.durationSec = Number(duration);
            } else {
                const clipStart = row.querySelector(".scene-clip-start").value;
                const clipDuration = row.querySelector(".scene-clip-duration").value;
                scene.clipStartSec = clipStart ? Number(clipStart) : 0;
                if (clipDuration) {
                    scene.clipDurationSec = Number(clipDuration);
                }
            }

            if (transitionType === "CROSSFADE") {
                if (!transitionDuration) {
                    return { error: `Scene ${index + 1} transition duration is required for CROSSFADE.` };
                }
                scene.transition.transitionDurationSec = Number(transitionDuration);
            }

            const captionText = row.querySelector(".scene-caption-text").value.trim();
            const captionStart = row.querySelector(".scene-caption-start").value;
            const captionEnd = row.querySelector(".scene-caption-end").value;
            const captionPosition = row.querySelector(".scene-caption-position").value;
            const filter = row.querySelector(".scene-filter").value;
            const brightness = Number(row.querySelector(".scene-brightness").value || 0);
            const contrast = Number(row.querySelector(".scene-contrast").value || 1);
            const saturation = Number(row.querySelector(".scene-saturation").value || 1);
            const overlayColor = row.querySelector(".scene-overlay-color").value;
            const overlayOpacity = Number(row.querySelector(".scene-overlay-opacity").value || 0);

            if (captionText) {
                scene.caption = {
                    text: captionText,
                    startOffsetSec: captionStart ? Number(captionStart) : 0,
                    position: captionPosition,
                };
                if (captionEnd) {
                    scene.caption.endOffsetSec = Number(captionEnd);
                }
            }

            scene.visualEdit = {
                filter,
                colorGrade: {
                    brightness,
                    contrast,
                    saturation,
                },
            };

            if (overlayOpacity > 0) {
                scene.visualEdit.overlay = {
                    hexColor: overlayColor,
                    opacity: overlayOpacity,
                };
            }

            scenes.push(scene);
        }

        return {
            manifest: {
                outputPreset: document.getElementById("outputPreset").value,
                scenes,
            },
            assets,
        };
    }

    function renderStatus(job) {
        let message = `Job ${job.jobId}: ${job.state}. ${job.message}`;
        if (job.youtubeVideoUrl) {
            message += `\nVideo URL: ${job.youtubeVideoUrl}`;
        }
        if (job.warningMessage) {
            message += `\nWarning: ${job.warningMessage}`;
        }
        status.innerText = message;
    }

    function pollJobStatus(jobId) {
        if (activePoll) {
            clearInterval(activePoll);
        }

        activePoll = setInterval(async () => {
            try {
                const response = await fetch(`/api/video/status/${jobId}`);
                if (!response.ok) {
                    status.innerText = await response.text();
                    clearInterval(activePoll);
                    activePoll = null;
                    return;
                }

                const job = await response.json();
                renderStatus(job);

                if (job.state === "COMPLETED" || job.state === "FAILED") {
                    clearInterval(activePoll);
                    activePoll = null;
                }
            } catch (error) {
                status.innerText = "Status check failed: " + error.message;
                clearInterval(activePoll);
                activePoll = null;
            }
        }, 3000);
    }
</script>

</body>

</html>
